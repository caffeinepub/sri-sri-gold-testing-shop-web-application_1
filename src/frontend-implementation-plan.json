{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Repair auth handshake flows, fix canister-backed user visibility, and remove appointment serial number UI",
  "requirements": [
    {
      "id": "REQ-25",
      "summary": "Prevent post-login runtime failures by ensuring canister calls are made only after role/session is established and by surfacing clear unauthorized/actor errors across feature pages.",
      "acceptanceCriteria": [
        "After successful Customer login, the following actions work end-to-end without throwing runtime errors: (1) lookup test result by serial number, (2) submit feedback, (3) submit an appointment request, (4) view Daily Gold Updates.",
        "After successful Owner login, Owner Dashboard tabs load without runtime errors: Appointments list, Feedback list, Users list, Test Results manager, Daily Gold Updates manager.",
        "If the backend rejects a call due to authorization, the UI shows a clear English error message explaining the user needs to sign in properly (not a blank screen or generic failure)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Harden React Query hooks to avoid \"Actor not available\" and authorization-related runtime errors by ensuring queries/mutations are appropriately gated and by propagating detailed errors (use frontend-side handling compatible with the selected \"authorization\" component’s role-based access control model). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/TestResultsLookupPage.tsx",
          "operation": "modify",
          "description": "Replace generic query error UI with detailed English error messaging (including unauthorized/sign-in guidance) using the shared canister error extraction utility, so lookup failures never present as blank/generic failures. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/DailyGoldUpdatesPage.tsx",
          "operation": "modify",
          "description": "Improve query error UI to show extracted canister error details in English and explicitly instruct users to sign in properly when authorization fails, preventing confusing generic error states. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/owner/OwnerDashboardPage.tsx",
          "operation": "modify",
          "description": "Add explicit error states for Appointments/Feedback data loading and show extracted canister error details in English (including unauthorized/sign-in guidance) so all dashboard tabs fail gracefully rather than throwing runtime errors. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-27",
      "summary": "Update the login flow to perform a backend role/session handshake after local username/password validation and block navigation until handshake succeeds.",
      "acceptanceCriteria": [
        "Customer login: on successful local credential validation, the app calls the backend customer-session handshake; only then navigates to /welcome.",
        "Owner login: on successful local credential validation, the app calls the backend owner-session handshake; only then navigates to /owner-dashboard.",
        "If the handshake fails, the user stays on the login page and sees an English error explaining sign-in could not be completed."
      ],
      "file_operations": [
        {
          "path": "frontend/src/auth/authStore.ts",
          "operation": "modify",
          "description": "Extend the auth store to track handshake/session establishment state (e.g., \"handshakeComplete\" and a setter/clearer) so the router and pages can block protected navigation until the backend role/session is confirmed (aligned with the selected \"authorization\" component’s RBAC expectations). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/LoginPage.tsx",
          "operation": "modify",
          "description": "After local username/password validation succeeds, call the backend role/session handshake (customer vs owner) via the authenticated actor; only navigate on success; otherwise remain on the login page with an English error and clear any partial auth state. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Tighten protected-route guards to require both local authentication and successful backend handshake state before allowing access to feature pages and owner dashboard, redirecting to /login with a clear sign-in requirement when missing. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-28",
      "summary": "Render Owner “Users Update” from canister-backed customer data and ensure registration success/failure reflects canister persistence.",
      "acceptanceCriteria": [
        "After a customer registers in frontend/src/pages/RegisterPage.tsx, the customer record is saved in the backend canister and the UI shows an English success state (or a detailed English failure reason if the canister call fails).",
        "Owner Dashboard “Users Update” shows customers fetched from the canister and updates after a refresh (or automatically via React Query invalidation).",
        "The owner can see at least: username, mobile number, and registration date for each registered customer from the canister data."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/RegisterPage.tsx",
          "operation": "modify",
          "description": "Reorder registration to treat the canister write as the source of truth: call the canister customer-create flow first, show an English success state only after it succeeds, and show extracted English error details when it fails; ensure localStorage-based customer cache is updated only after canister success to avoid owner/user mismatch. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/owner/UsersUpdateSection.tsx",
          "operation": "modify",
          "description": "Replace localStorage-only customer loading with canister-backed fetching via existing React Query hooks, add manual refresh via query invalidation/refetch, and render at least username/mobile number/registration date from canister data (handle missing date defensively if backend returns it as an optional field). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Ensure customer-related mutations invalidate/refetch the canister-backed customers query so Owner Dashboard updates after registration (or after a manual refresh) without relying on localStorage. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-29",
      "summary": "Remove Serial Number input from customer appointment booking form while keeping submission functional with a backend-safe placeholder value.",
      "acceptanceCriteria": [
        "frontend/src/pages/AppointmentsPage.tsx no longer displays the “Serial Number / Reference” input.",
        "Submitting an appointment request still succeeds and shows the existing English success toast/message.",
        "No validation error requires a serial number in the appointment booking UI."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/AppointmentsPage.tsx",
          "operation": "modify",
          "description": "Remove the Serial Number / Reference field from the appointment form UI and validation; ensure submission sends an empty string or backend-safe placeholder value for serialNumber while preserving the existing success UI behavior. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-30",
      "summary": "Remove Serial Number from Owner Dashboard appointment display table.",
      "acceptanceCriteria": [
        "In the Owner Dashboard appointments tab (frontend/src/pages/owner/OwnerDashboardPage.tsx), the appointments table no longer has a “Serial Number” column and does not render appointment.serialNumber."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/owner/OwnerDashboardPage.tsx",
          "operation": "modify",
          "description": "Update the owner appointments table to remove the Serial Number column and any rendering of appointment.serialNumber, keeping the rest of the table functional. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-31",
      "summary": "Surface detailed English canister error messages for feature queries and mutations (Appointments, Feedback, Customers) instead of generic retry prompts.",
      "acceptanceCriteria": [
        "When submitting feedback fails, the toast/alert includes the extracted canister error detail (English).",
        "When submitting an appointment fails, the toast/alert includes the extracted canister error detail (English).",
        "When customer registration fails due to canister call failure, the UI shows an English error with the underlying reason when available (not only a generic message)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/FeedbackPage.tsx",
          "operation": "modify",
          "description": "Use the shared error extraction helper to display the underlying canister failure reason in English in the toast/alert when feedback submission fails (including authorization/sign-in guidance when applicable). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/AppointmentsPage.tsx",
          "operation": "modify",
          "description": "Use the shared error extraction helper to display the underlying canister failure reason in English in the toast/alert when appointment submission fails (including authorization/sign-in guidance when applicable). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/RegisterPage.tsx",
          "operation": "modify",
          "description": "Replace generic registration failure messaging with extracted English canister error details so users see the actual reason when backend persistence fails. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/utils/canisterErrors.ts",
          "operation": "modify",
          "description": "Enhance error extraction to better handle common agent/canister error shapes (including nested fields) so UI pages can reliably show actionable English messages instead of generic text. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}